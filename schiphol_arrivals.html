<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schiphol Arrival Flights</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin: auto;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h2>Upcoming Schiphol Arrivals</h2>
    <span>
        <p id="last-updated">Last updated: ${new Date().toLocaleString()} (Updates Every Minute)</p>

    </span>
    <table id="flights-table" style="margin: 0 20px;">
        <thead>
            <tr>
                <th>Flight Number</th>
                <th>Airline</th>
                <th class="toggle-columns hidden">Provenance Code</th>
                <th>Provenance</th>
                <th>Minutes Until Landing</th>
                <th>Aircraft Type</th>
                <th class="toggle-columns hidden">Page Number</th>
                <th class="toggle-columns hidden">Registration</th>
                <th class="toggle-columns hidden">Coordinates</th>
                <th>Runway</th>
            </tr>
        </thead>
        <tbody>
            <!-- Flight data will be populated here -->
        </tbody>
    </table>
    <script>
        const ws = new WebSocket('ws://localhost:3000/ws'); // Use /ws

        ws.onopen = function () {
            console.log("WebSocket connection established.");
        };


        ws.onmessage = function (event) {
            // console.log("Received WebSocket message:", event.data);
            console.log("Received WebSocket message");


            try {
                const updatedFlights = JSON.parse(event.data);

                // Ensure the received data is an array before updating the table
                if (Array.isArray(updatedFlights)) {
                    console.log("✅ Valid flight data received.");
                    updateFlightsTable(updatedFlights);
                } else {
                    console.warn("⚠️ Received non-flight data:", updatedFlights);
                }

                // Update last updated time
                document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleString()} (Updates Every Minute)`;

            } catch (error) {
                console.error("⚠️ Error parsing WebSocket message:", error);
            }
        };

        ws.onerror = function (error) {
            console.error("WebSocket error:", error);
        };

        ws.onclose = function () {
            console.log("WebSocket connection closed.");
        };

        function updateFlightsTable(flights) {
            const table = document.getElementById('flights-table');

            // Remove any existing tbody if present
            let oldTbody = table.querySelector("tbody");
            if (oldTbody) {
                table.removeChild(oldTbody);
            }

            // Create a new tbody
            let tbody = document.createElement("tbody");

            console.log("flights")
            console.log(flights)

            flights.forEach(flight => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${flight.mainFlight}</td>
            <td>${flight.airlineName}</td>
            <td class="toggle-columns hidden">${flight.destinations}</td>
            <td>${flight.destinationNames.join(', ')}</td>
            <td>${flight.minutesUntilLanding}</td>
            <td>${flight.iataSub}</td>
            <td class="toggle-columns hidden">${flight.pageNumber}</td>
            <td class="toggle-columns hidden">${flight.registration}</td>
            <td class="toggle-columns hidden">${Array.isArray(flight.coordinates) ? flight.coordinates.join(', ') : 'Unknown'}</td>
            <td>${flight.runway}</td>
        `;
                tbody.appendChild(row);
            });

            // Append the new tbody to the table
            table.appendChild(tbody);
        }

        document.addEventListener("DOMContentLoaded", function () {
            const toggleButton = document.createElement("button");
            toggleButton.textContent = "Toggle Columns";
            toggleButton.style.margin = "10px"; // Updated margin style
            // Append the button after the table
            const table = document.querySelector("table");
            table.insertAdjacentElement("afterend", toggleButton);

            // Toggle button functionality
            toggleButton.addEventListener("click", function () {
                const registrationCells = document.querySelectorAll(".toggle-columns");

                registrationCells.forEach(cell => {
                    cell.classList.toggle("hidden");
                });
            });
        });
    </script>
</body>

</html>